<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IP Camera Viewer</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background-color: #f0f0f0;
            font-family: Arial, sans-serif;
        }
        .container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
            max-width: 100%;
            margin: 0 auto;
            height: calc(100vh - 220px);
            overflow-y: auto;
        }
        .container.maximized {
            display: block;
            height: calc(100vh - 220px);
        }
        .cam-container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
            position: relative;
        }
        .cam-container.maximized {
            width: 100%;
            height: 100%;
        }
        .cam-header {
            padding: 10px;
            background-color: #333;
            color: white;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .cam-frame, .cam-image {
            width: 100%;
            height: 200px; /* Reduced height to make space for the download button */
            border: none;
            display: block;
            object-fit: contain;
        }
        .cam-frame.maximized, .cam-image.maximized {
            height: calc(100% - 80px); /* Adjusted for the download button in maximized view */
        }
        .error, .download-container {
            background-color: #ffe6e6;
            padding: 10px;
            text-align: center;
            font-size: 14px;
            color: #333;
            height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .download-container.maximized {
            height: calc(100% - 80px);
        }
        .download-btn, .download-all-btn, .generate-urls-btn {
            padding: 8px 16px;
            margin-top: 10px;
            background-color: #17a2b8;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .download-btn:hover, .download-all-btn:hover, .generate-urls-btn:hover {
            background-color: #138496;
        }
        .download-all-btn, .generate-urls-btn {
            margin-left: 10px;
            margin-top: 0;
        }
        .start-page-input {
            min-width: 80px;
            padding: 8px;
            margin-left: 10px;
            font-size: 14px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }
        .controls {
            max-width: 100%;
            margin: 20px auto;
            text-align: center;
        }
        .input-section {
            max-width: 100%;
            margin: 20px auto;
            text-align: center;
        }
        .pagination {
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
        }
        .pagination button {
            margin: 5px;
        }
        .pagination .separator {
            margin: 0 10px;
            color: #666;
            font-size: 14px;
        }
        button {
            padding: 8px 16px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .maximize-btn, .restore-btn {
            padding: 5px 10px;
            background-color: #28a745;
        }
        .maximize-btn:hover, .restore-btn:hover {
            background-color: #218838;
        }
        textarea {
            width: 100%;
            max-width: 600px;
            height: 60px;
            margin: 10px 0;
            padding: 8px;
            font-size: 14px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }
        .error-message {
            color: #dc3545;
            font-size: 14px;
            margin-top: 5px;
            display: none;
        }
        .download-status {
            max-width: 600px;
            margin: 10px auto;
            padding: 8px;
            font-size: 14px;
            color: #333;
            background-color: #e9ecef;
            border-radius: 4px;
            max-height: 100px;
            overflow-y: auto;
            display: none;
        }
    </style>
</head>
<body>
    <div class="input-section">
        <textarea id="cameraInput" placeholder='Paste your camera URLs as a JSON array, e.g. ["http://example1:80", "http://example2:81"]'></textarea>
        <div>
            <button id="submitButton">Submit Cameras</button>
            <button id="downloadAllButton" class="download-all-btn" style="display: none;">Download All</button>
            <button id="generateUrlsButton" class="generate-urls-btn" style="display: none;">Generate URL List</button>
            <input type="number" id="startPageInput" class="start-page-input" placeholder="Start page" min="1" style="display: none;">
        </div>
        <div id="errorMessage" class="error-message">Invalid input. Please provide a valid JSON array of URLs.</div>
        <div id="downloadStatus" class="download-status"></div>
    </div>
    <div class="controls">
        <button id="loadButton" style="display: none;">Load Cameras</button>
        <div class="pagination" id="pagination"></div>
    </div>
    <div class="container" id="camContainer"></div>

    <script>
        let camUrls = [];
        const camsPerPage = 8;
        let currentPage = 1;
        let isLoaded = false;
        let maximizedCam = null;

        const container = document.getElementById('camContainer');
        const pagination = document.getElementById('pagination');
        const loadButton = document.getElementById('loadButton');
        const cameraInput = document.getElementById('cameraInput');
        const submitButton = document.getElementById('submitButton');
        const downloadAllButton = document.getElementById('downloadAllButton');
        const generateUrlsButton = document.getElementById('generateUrlsButton');
        const startPageInput = document.getElementById('startPageInput');
        const errorMessage = document.getElementById('errorMessage');
        const downloadStatus = document.getElementById('downloadStatus');

        // Load saved data on page load
        function loadSavedData() {
            const savedUrls = localStorage.getItem('cameraUrls');
            const savedPage = localStorage.getItem('currentPage');

            if (savedUrls) {
                try {
                    const parsedUrls = JSON.parse(savedUrls);
                    if (Array.isArray(parsedUrls) && parsedUrls.every(url => typeof url === 'string' && url.startsWith('http'))) {
                        camUrls = parsedUrls;
                        cameraInput.value = JSON.stringify(camUrls);
                        loadButton.style.display = 'inline-block';
                        downloadAllButton.style.display = 'inline-block';
                        generateUrlsButton.style.display = 'inline-block';
                        startPageInput.style.display = 'inline-block';
                        renderPagination();
                    } else {
                        localStorage.removeItem('cameraUrls');
                    }
                } catch (e) {
                    localStorage.removeItem('cameraUrls');
                }
            }

            if (savedPage) {
                const pageNum = parseInt(savedPage);
                if (!isNaN(pageNum) && pageNum > 0) {
                    currentPage = pageNum;
                }
            }
        }

        function createCamElement(url) {
            const camDiv = document.createElement('div');
            camDiv.className = 'cam-container';
            camDiv.dataset.url = url;

            const header = document.createElement('div');
            header.className = 'cam-header';

            const urlSpan = document.createElement('span');
            urlSpan.textContent = url;

            const maximizeBtn = document.createElement('button');
            maximizeBtn.className = 'maximize-btn';
            maximizeBtn.textContent = 'Maximize';
            maximizeBtn.onclick = () => maximizeCam(camDiv);
            header.appendChild(maximizeBtn);
            header.appendChild(urlSpan);

            const restoreBtn = document.createElement('button');
            restoreBtn.className = 'restore-btn';
            restoreBtn.textContent = 'Restore';
            restoreBtn.style.display = 'none';
            restoreBtn.onclick = () => restoreCam();
            header.appendChild(restoreBtn);

            camDiv.appendChild(header);

            // Check if the URL is a displayable image
            const isImage = url.toLowerCase().endsWith('.jpg') ||
                           url.toLowerCase().endsWith('.jpeg') ||
                           url.toLowerCase().endsWith('.png') ||
                           url.toLowerCase().endsWith('.gif') ||
                           url.toLowerCase().endsWith('.bmp') ||
                           url.toLowerCase().endsWith('.webp');

            if (isImage) {
                const img = document.createElement('img');
                img.className = 'cam-image';
                img.src = url;
                img.alt = `Camera image at ${url}`;
                img.onerror = () => {
                    img.remove();
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'error';
                    errorDiv.textContent = 'Failed to load camera image. Right-click the URL above to download manually.';
                    camDiv.appendChild(errorDiv);
                };
                camDiv.appendChild(img);

                // Add a download button for images
                const downloadBtn = document.createElement('button');
                downloadBtn.className = 'download-btn';
                downloadBtn.textContent = 'Download';
                downloadBtn.onclick = () => {
                    const filename = url.split('/').pop() || 'image.jpg';
                    triggerDownload(url, filename);
                };
                camDiv.appendChild(downloadBtn);
            } else {
                // Try to load as an iframe (for potential live feeds)
                const iframe = document.createElement('iframe');
                iframe.className = 'cam-frame';
                iframe.src = url;
                iframe.title = `Camera at ${url}`;
                iframe.onerror = () => {
                    iframe.remove();
                    // If iframe fails, show a message
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'error';
                    errorDiv.textContent = 'Failed to load camera feed. Right-click the URL above to download manually.';
                    camDiv.appendChild(errorDiv);
                };
                camDiv.appendChild(iframe);
            }

            return camDiv;
        }

        function maximizeCam(camDiv) {
            if (maximizedCam) return;

            maximizedCam = camDiv;
            container.classList.add('maximized');

            Array.from(container.children).forEach(child => {
                if (child !== camDiv) child.style.display = 'none';
            });

            camDiv.classList.add('maximized');
            const camFrame = camDiv.querySelector('.cam-frame') ||
                           camDiv.querySelector('.cam-image') ||
                           camDiv.querySelector('.download-container');
            if (camFrame) camFrame.classList.add('maximized');
            camDiv.querySelector('.maximize-btn').style.display = 'none';
            camDiv.querySelector('.restore-btn').style.display = 'inline-block';

            pagination.style.display = 'none';
            loadButton.style.display = 'none';
        }

        function restoreCam() {
            if (!maximizedCam) return;

            container.classList.remove('maximized');

            Array.from(container.children).forEach(child => {
                child.style.display = 'block';
            });

            maximizedCam.classList.remove('maximized');
            const camFrame = maximizedCam.querySelector('.cam-frame') ||
                           maximizedCam.querySelector('.cam-image') ||
                           camDiv.querySelector('.download-container');
            if (camFrame) camFrame.classList.remove('maximized');
            maximizedCam.querySelector('.maximize-btn').style.display = 'inline-block';
            maximizedCam.querySelector('.restore-btn').style.display = 'none';

            maximizedCam = null;

            pagination.style.display = 'block';
            loadButton.style.display = 'inline-block';
        }

        function renderCams(page) {
            container.innerHTML = '';
            const start = (page - 1) * camsPerPage;
            const end = start + camsPerPage;
            const pageCams = camUrls.slice(start, end);

            pageCams.forEach(url => {
                const camElement = createCamElement(url);
                container.appendChild(camElement);
            });

            renderPagination();
        }

        function renderPagination() {
            pagination.innerHTML = '';
            const totalPages = Math.ceil(camUrls.length / camsPerPage);

            // First Previous button
            const prevButton1 = document.createElement('button');
            prevButton1.textContent = 'Previous';
            prevButton1.disabled = currentPage === 1;
            prevButton1.onclick = () => {
                if (currentPage > 1) {
                    currentPage--;
                    localStorage.setItem('currentPage', currentPage);
                    renderCams(currentPage);
                }
            };
            pagination.appendChild(prevButton1);

            // First Next button
            const nextButton1 = document.createElement('button');
            nextButton1.textContent = 'Next';
            nextButton1.disabled = currentPage === totalPages;
            nextButton1.onclick = () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    localStorage.setItem('currentPage', currentPage);
                    renderCams(currentPage);
                }
            };
            pagination.appendChild(nextButton1);

            // Separator
            const separator1 = document.createElement('span');
            separator1.className = 'separator';
            separator1.textContent = '|';
            pagination.appendChild(separator1);

            // Page buttons
            for (let i = 1; i <= totalPages; i++) {
                const pageButton = document.createElement('button');
                pageButton.textContent = i;
                pageButton.disabled = i === currentPage;
                pageButton.onclick = () => {
                    currentPage = i;
                    localStorage.setItem('currentPage', currentPage);
                    renderCams(currentPage);
                };
                pagination.appendChild(pageButton);
            }

            // Separator
            const separator2 = document.createElement('span');
            separator2.className = 'separator';
            separator2.textContent = '|';
            pagination.appendChild(separator2);

            // Second Previous button
            const prevButton2 = document.createElement('button');
            prevButton2.textContent = 'Previous';
            prevButton2.disabled = currentPage === 1;
            prevButton2.onclick = () => {
                if (currentPage > 1) {
                    currentPage--;
                    localStorage.setItem('currentPage', currentPage);
                    renderCams(currentPage);
                }
            };
            pagination.appendChild(prevButton2);

            // Second Next button
            const nextButton2 = document.createElement('button');
            nextButton2.textContent = 'Next';
            nextButton2.disabled = currentPage === totalPages;
            nextButton2.onclick = () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    localStorage.setItem('currentPage', currentPage);
                    renderCams(currentPage);
                }
            };
            pagination.appendChild(nextButton2);
        }

        // Function to trigger a download using the image URL
        function triggerDownload(url, filename) {
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Function to download all images starting from the specified page
        async function downloadAllImages(urls) {
            const startPage = parseInt(startPageInput.value) || 1;
            const totalPages = Math.ceil(urls.length / camsPerPage);
            const batchSize = 5; // Number of files to download at a time

            // Validate the start page
            if (startPage < 1 || startPage > totalPages) {
                downloadStatus.style.display = 'block';
                downloadStatus.innerHTML = `Invalid start page. Please enter a number between 1 and ${totalPages}.<br>`;
                return;
            }

            // Calculate the starting index based on the page
            const startIndex = (startPage - 1) * camsPerPage;

            downloadStatus.style.display = 'block';
            downloadStatus.innerHTML = `Starting downloads from page ${startPage}...<br>`;
            downloadStatus.innerHTML += `Note: If downloads do not start, right-click the images and select "Save Image As" to download manually.<br>`;

            for (let i = startIndex; i < urls.length; i += batchSize) {
                const batch = urls.slice(i, i + batchSize);

                for (const [batchIndex, url] of batch.entries()) {
                    const globalIndex = i + batchIndex;
                    const filename = url.split('/').pop() || `image_${globalIndex}.jpg`;

                    // Check if the URL is an image
                    const isImage = url.toLowerCase().endsWith('.jpg') ||
                                   url.toLowerCase().endsWith('.jpeg') ||
                                   url.toLowerCase().endsWith('.png') ||
                                   url.toLowerCase().endsWith('.gif') ||
                                   url.toLowerCase().endsWith('.bmp') ||
                                   url.toLowerCase().endsWith('.webp');

                    if (!isImage) {
                        downloadStatus.innerHTML += `Skipping ${filename}: Not a displayable image format.<br>`;
                        continue;
                    }

                    downloadStatus.innerHTML += `Initiating download for ${filename}...<br>`;
                    triggerDownload(url, filename);
                    downloadStatus.scrollTop = downloadStatus.scrollHeight;

                    // Small delay between individual downloads in a batch
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }

                // Wait 5 seconds between batches to allow the browser to handle downloads
                await new Promise(resolve => setTimeout(resolve, 5000));
            }

            downloadStatus.innerHTML += 'All downloads initiated. Check your browser\'s download manager for progress.<br>';
            downloadStatus.scrollTop = downloadStatus.scrollHeight;
        }

        // Function to generate a text file with URLs starting from the specified page
        function generateUrlList(urls) {
            const startPage = parseInt(startPageInput.value) || 1;
            const totalPages = Math.ceil(urls.length / camsPerPage);

            // Validate the start page
            if (startPage < 1 || startPage > totalPages) {
                downloadStatus.style.display = 'block';
                downloadStatus.innerHTML = `Invalid start page. Please enter a number between 1 and ${totalPages}.<br>`;
                return;
            }

            // Calculate the starting index based on the page
            const startIndex = (startPage - 1) * camsPerPage;
            const urlsToDownload = urls.slice(startIndex);

            // Create a text blob with the URLs
            const urlText = urlsToDownload.join('\n');
            const blob = new Blob([urlText], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);

            // Create a link to download the text file
            const link = document.createElement('a');
            link.href = url;
            link.download = `camera_urls_from_page_${startPage}.txt`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            window.URL.revokeObjectURL(url);

            // Update status message
            downloadStatus.style.display = 'block';
            downloadStatus.innerHTML = `URL list generated as "camera_urls_from_page_${startPage}.txt".<br>`;
            downloadStatus.innerHTML += `Use a download manager with the generated URL list.<br>`;
            downloadStatus.innerHTML += `For example, with wget: <code>wget -i camera_urls_from_page_${startPage}.txt</code><br>`;
            downloadStatus.scrollTop = downloadStatus.scrollHeight;
        }

        submitButton.onclick = () => {
            try {
                const input = cameraInput.value.trim();
                if (!input) {
                    errorMessage.style.display = 'block';
                    localStorage.removeItem('cameraUrls');
                    camUrls = [];
                    downloadAllButton.style.display = 'none';
                    generateUrlsButton.style.display = 'none';
                    startPageInput.style.display = 'none';
                    downloadStatus.style.display = 'none';
                    return;
                }
                const parsedUrls = JSON.parse(input);
                if (!Array.isArray(parsedUrls) || !parsedUrls.every(url => typeof url === 'string' && url.startsWith('http'))) {
                    throw new Error('Invalid array of URLs');
                }
                camUrls = parsedUrls;
                localStorage.setItem('cameraUrls', JSON.stringify(camUrls));
                errorMessage.style.display = 'none';
                loadButton.style.display = 'inline-block';
                downloadAllButton.style.display = 'inline-block';
                generateUrlsButton.style.display = 'inline-block';
                startPageInput.style.display = 'inline-block';
                downloadStatus.style.display = 'none';
                currentPage = 1;
                localStorage.setItem('currentPage', currentPage);
                isLoaded = false;
                loadButton.textContent = 'Load Cameras';
                container.innerHTML = '';
                renderPagination();
            } catch (e) {
                errorMessage.style.display = 'block';
                localStorage.removeItem('cameraUrls');
                camUrls = [];
                downloadAllButton.style.display = 'none';
                generateUrlsButton.style.display = 'none';
                startPageInput.style.display = 'none';
                downloadStatus.style.display = 'none';
            }
        };

        downloadAllButton.onclick = () => {
            if (camUrls.length > 0) {
                downloadAllImages(camUrls);
            }
        };

        generateUrlsButton.onclick = () => {
            if (camUrls.length > 0) {
                generateUrlList(camUrls);
            }
        };

        loadButton.onclick = () => {
            if (!isLoaded) {
                isLoaded = true;
                loadButton.textContent = 'Reload Cameras';
                renderCams(currentPage);
            } else {
                container.innerHTML = '';
                maximizedCam = null;
                renderCams(currentPage);
            }
        };

        window.addEventListener('resize', () => {
            if (!maximizedCam) {
                renderCams(currentPage);
            }
        });

        // Initialize with saved data
        loadSavedData();
    </script>
</body>
</html>
